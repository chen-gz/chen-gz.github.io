---
title: E2. Submedians (Hard Version)
type: docs
math: true
---

[View on Codeforces](https://codeforces.com/contest/2128/problem/E2)

## Problem Statement

This is the hard version of the problem. You are asked to find **all submedians** and for each, any corresponding subarray.

### Definition

An integer $v$ is a **median** of an array $b$ of length $m$ if and only if:

- $v$ is greater than or equal to at least $\lceil \frac{m}{2} \rceil$ elements of the array, and
- $v$ is less than or equal to at least $\lceil \frac{m}{2} \rceil$ elements of the array.

#### Examples

- The only median of $[9, 3, 7]$ is $7$.
- The medians of $[5, 3, 7, 9]$ are $5$, $6$, and $7$.
- The only median of $[2, 2, 2]$ is $2$.

### Task

You're given an integer $k$ and an array $a_1, \ldots, a_n$ of integers between $1$ and $n$.

An integer $v$ from $1$ to $n$ is said to be a **submedian** if there exists at least one pair of indices $(l, r)$ such that:

- $1 \leq l \leq r \leq n$
- $r - l + 1 \geq k$
- $v$ is a median of the subarray $[a_l, \ldots, a_r]$

Find **all submedians** and for each, any corresponding pair of indices $(l, r)$.


### Input

Each test contains multiple test cases.  
The first line contains the number of test cases $t$ ($1 \leq t \leq 50\,000$).  
The description of the test cases follows.

- The first line of each test case contains two integers $n$ and $k$ ($1 \leq k \leq n \leq 300\,000$).
- The second line of each test case contains $n$ integers $a_1, a_2, \ldots, a_n$ ($1 \leq a_i \leq n$).

It is guaranteed that the sum of $n$ over all test cases doesn't exceed $300\,000$.


### Output

For each test case, output your answer in the following format:

- On the first line, output $c$, the number of submedians.
- On the $i$-th of the following $c$ lines, output three integers $v_i$, $l_i$, and $r_i$ such that $r_i - l_i + 1 \geq k$ and $v_i$ is one of the medians of the subarray $[a_{l_i}, \ldots, a_{r_i}]$.

Each submedian should be reported exactly once, that is, integers $v_1, \ldots, v_c$ must be pairwise distinct. The order in which they are reported does not matter.

If there are many solutions, you can print any of them.

## Solution

[submission](https://codeforces.com/contest/2128/submission/337203561)